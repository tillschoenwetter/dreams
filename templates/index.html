<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>DreamAtlas</title>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="icon" href="data:,"> <!-- Prevent favicon.ico 404 -->

  <style>
    body.loading {
      cursor: progress;
    }
  </style>
</head>
<body>
  {% if not user_dream %}
    <!-- Input view -->
    <div class="input-container">
      <h1>DreamAtlas</h1>
      <form method="post" id="dreamForm">
        <textarea name="dream" placeholder="Describe your dream..."></textarea><br>
        <button type="submit">Submit Dream</button>
        <button type="button" data-explore style="margin-top: 10px;">Explore Dreams</button>
      </form>
    </div>
  {% else %}
    <!-- Constellation view -->
    <div class="constellation-container">
      <div class="header">
        <!-- Add search input -->
        <div class="search-container">
          <input type="text" id="dreamSearch" placeholder="Search dreams..." />
        </div>

        <!-- Existing threshold slider -->
        <div class="threshold-slider">
          <label for="similarityRange">Constellation Visibility: <span id="thresholdValue">0.35</span></label>
          <input type="range" min="0.0" max="1.0" step="0.01" value="0.50" id="similarityRange" />
        </div>

        <button onclick="window.location.href='/'">Submit Another Dream</button>
        <p style="font-size:12px; text-align:center; margin-top:5px;">
          for feedback or questions, please contact us at hello@dreamatlas.cloud
        </p>
      </div>

      <!-- Similar dreams panel - removed if condition -->
      <div class="similar-panel" id="similarPanel">
        <div class="similar-panel-header" id="similarPanelHeader">
          <span>Most Similar Dreams</span>
          <span id="toggleButton">â€“</span>
        </div>
        <div class="similar-panel-content" id="similarPanelContent">
          <ul>
            {% for s in top_similar %}
              <li onclick="panelClick({{ s[0] }})" style="cursor:pointer;">
                {{ s[1] }}<br><small>Sim: {{ "%.2f"|format(s[2]) }}</small>
              </li>
            {% endfor %}
          </ul>
        </div>
      </div>

      <svg id="constellation"></svg>
      <div id="tooltip" class="tooltip" style="display: none;"></div>

      <!-- Constellation data -->
      <script>
        var nodes = {{ nodes|tojson }};
        var links = {{ links|tojson }};
        var newDreamId = {{ new_dream_id|tojson }};
      </script>
      <script src="{{ url_for('static', filename='script.js') }}"></script>
    </div>
  {% endif %}

  <!-- Spinner overlay always present -->
  <div id="preloadSpinner" class="spinner-overlay" style="display: none;">
    <div class="spinner"></div>
  </div>

  <!-- Spinner + location logic -->
  <script>
    const spinner = document.getElementById("preloadSpinner");
    const formEl = document.getElementById("dreamForm");

    // Show spinner on form submission
    if (formEl) {
      formEl.addEventListener("submit", function() {
        spinner.style.display = "flex";
        const locField = document.createElement("input");
        locField.type = "hidden";
        locField.name = "location";
        locField.value = Intl.DateTimeFormat().resolvedOptions().timeZone; // Use timezone instead
        formEl.appendChild(locField);
      });
    }

    // Show spinner immediately on Explore click
    const exploreBtn = document.querySelector("button[data-explore]");
    if (exploreBtn) {
      exploreBtn.addEventListener("click", function() {
        spinner.style.display = "flex";
        window.location.href = "/explore";
      });
    }
  </script>
</body>
</html>
